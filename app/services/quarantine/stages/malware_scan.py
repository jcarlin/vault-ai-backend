"""Stage 2: Malware Scanning — ClamAV, YARA rules, hash blacklist."""

import hashlib
from pathlib import Path

from app.services.quarantine.clamav import ClamAVClient
from app.services.quarantine.hash_blacklist import HashBlacklist
from app.services.quarantine.stages import PipelineStage, StageFinding, StageResult
from app.services.quarantine.yara_engine import YaraEngine


class MalwareScanStage(PipelineStage):
    """Stage 2: Scan files for malware using ClamAV, YARA rules, and hash blacklist."""

    def __init__(
        self,
        clamav_client: ClamAVClient | None = None,
        yara_engine: YaraEngine | None = None,
        hash_blacklist: HashBlacklist | None = None,
    ):
        self._clamav = clamav_client
        self._yara = yara_engine
        self._blacklist = hash_blacklist

    @property
    def name(self) -> str:
        return "malware_scan"

    async def scan(self, file_path: Path, original_filename: str, config: dict) -> StageResult:
        findings = []
        passed = True

        # 1. Hash blacklist check (fastest, do first)
        blacklist_findings = self._check_blacklist(file_path)
        findings.extend(blacklist_findings)
        for f in blacklist_findings:
            if f.severity in ("high", "critical"):
                passed = False

        # 2. ClamAV scan
        clamav_findings = self._check_clamav(file_path, config)
        findings.extend(clamav_findings)
        for f in clamav_findings:
            if f.severity in ("high", "critical"):
                passed = False

        # 3. YARA rules scan
        yara_findings = self._check_yara(file_path)
        findings.extend(yara_findings)
        for f in yara_findings:
            if f.severity in ("high", "critical"):
                passed = False

        return StageResult(passed=passed, findings=findings)

    def _check_blacklist(self, file_path: Path) -> list[StageFinding]:
        if not self._blacklist:
            return []

        sha256 = hashlib.sha256(file_path.read_bytes()).hexdigest()
        if self._blacklist.is_blacklisted(sha256):
            return [StageFinding(
                stage=self.name,
                severity="critical",
                code="hash_blacklisted",
                message=f"File SHA-256 hash matches known malicious file.",
                details={"sha256": sha256},
            )]
        return []

    def _check_clamav(self, file_path: Path, config: dict) -> list[StageFinding]:
        if not self._clamav:
            return []

        result = self._clamav.scan_file(file_path)
        status = result.get("status", "unavailable")

        if status == "infected":
            threat = result.get("threat", "Unknown")
            return [StageFinding(
                stage=self.name,
                severity="critical",
                code="clamav_infected",
                message=f"ClamAV detected threat: {threat}",
                details={"threat": threat, "engine": "clamav"},
            )]
        elif status == "unavailable":
            strictness = config.get("strictness_level", "standard")
            if strictness == "paranoid":
                # In paranoid mode, ClamAV being unavailable is a failure
                return [StageFinding(
                    stage=self.name,
                    severity="high",
                    code="clamav_unavailable",
                    message="ClamAV daemon is unavailable and strictness is 'paranoid'.",
                    details={"message": result.get("message", "")},
                )]
            else:
                return [StageFinding(
                    stage=self.name,
                    severity="low",
                    code="clamav_unavailable",
                    message="ClamAV daemon is not available — skipping virus scan.",
                    details={"message": result.get("message", "")},
                )]
        elif status == "error":
            return [StageFinding(
                stage=self.name,
                severity="medium",
                code="clamav_error",
                message=f"ClamAV scan error: {result.get('message', 'Unknown')}",
            )]
        # status == "clean"
        return []

    def _check_yara(self, file_path: Path) -> list[StageFinding]:
        if not self._yara or not self._yara.available:
            return []

        matches = self._yara.scan_file(file_path)
        findings = []
        for match in matches:
            rule_name = match.get("rule", "Unknown")
            meta = match.get("meta", {})
            severity = meta.get("severity", "high")
            if severity not in ("low", "medium", "high", "critical"):
                severity = "high"
            findings.append(StageFinding(
                stage=self.name,
                severity=severity,
                code="yara_match",
                message=f"YARA rule matched: {rule_name}",
                details={
                    "rule": rule_name,
                    "tags": match.get("tags", []),
                    "meta": meta,
                },
            ))
        return findings
