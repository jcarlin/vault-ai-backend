"""Unit tests for Stage 2: Malware Scanning."""

import json
from pathlib import Path

import pytest

from app.services.quarantine.hash_blacklist import HashBlacklist
from app.services.quarantine.stages.malware_scan import MalwareScanStage
from tests.mocks.fake_clamav import FakeClamAVClient


FIXTURES = Path(__file__).parent.parent / "fixtures" / "quarantine"


@pytest.fixture
def default_config():
    return {
        "max_file_size": 1073741824,
        "strictness_level": "standard",
    }


class TestClamAVScanning:
    @pytest.mark.asyncio
    async def test_clean_file_passes(self, default_config):
        stage = MalwareScanStage(clamav_client=FakeClamAVClient(available=True))
        result = await stage.scan(FIXTURES / "clean.txt", "clean.txt", default_config)
        assert result.passed
        clamav_findings = [f for f in result.findings if f.code == "clamav_infected"]
        assert len(clamav_findings) == 0

    @pytest.mark.asyncio
    async def test_eicar_detected(self, default_config):
        stage = MalwareScanStage(clamav_client=FakeClamAVClient(available=True))
        result = await stage.scan(FIXTURES / "eicar.txt", "eicar.txt", default_config)
        assert not result.passed
        infected = [f for f in result.findings if f.code == "clamav_infected"]
        assert len(infected) > 0
        assert "EICAR" in infected[0].details.get("threat", "")

    @pytest.mark.asyncio
    async def test_clamav_unavailable_standard_mode(self, default_config):
        """In standard mode, ClamAV being unavailable is a low-severity warning."""
        stage = MalwareScanStage(clamav_client=FakeClamAVClient(available=False))
        result = await stage.scan(FIXTURES / "clean.txt", "clean.txt", default_config)
        assert result.passed  # Doesn't fail in standard mode
        unavail = [f for f in result.findings if f.code == "clamav_unavailable"]
        assert len(unavail) > 0
        assert unavail[0].severity == "low"

    @pytest.mark.asyncio
    async def test_clamav_unavailable_paranoid_mode(self):
        """In paranoid mode, ClamAV being unavailable fails the scan."""
        config = {"strictness_level": "paranoid"}
        stage = MalwareScanStage(clamav_client=FakeClamAVClient(available=False))
        result = await stage.scan(FIXTURES / "clean.txt", "clean.txt", config)
        assert not result.passed
        unavail = [f for f in result.findings if f.code == "clamav_unavailable"]
        assert len(unavail) > 0
        assert unavail[0].severity == "high"

    @pytest.mark.asyncio
    async def test_no_clamav_client(self, default_config):
        """If no ClamAV client is configured, skip silently."""
        stage = MalwareScanStage(clamav_client=None)
        result = await stage.scan(FIXTURES / "clean.txt", "clean.txt", default_config)
        assert result.passed


class TestHashBlacklist:
    @pytest.mark.asyncio
    async def test_blacklisted_hash_detected(self, tmp_path, default_config):
        # SHA-256 of empty file
        bl_path = tmp_path / "blacklist.json"
        bl_path.write_text(json.dumps({
            "hashes": ["e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"]
        }))
        blacklist = HashBlacklist(blacklist_path=str(bl_path))
        blacklist.load()

        # Create an empty file (its hash is the one we blacklisted)
        empty_file = tmp_path / "empty.bin"
        empty_file.write_bytes(b"")

        stage = MalwareScanStage(hash_blacklist=blacklist)
        result = await stage.scan(empty_file, "empty.bin", default_config)
        assert not result.passed
        bl_findings = [f for f in result.findings if f.code == "hash_blacklisted"]
        assert len(bl_findings) > 0

    @pytest.mark.asyncio
    async def test_clean_hash_passes(self, default_config):
        blacklist = HashBlacklist()
        stage = MalwareScanStage(hash_blacklist=blacklist)
        result = await stage.scan(FIXTURES / "clean.txt", "clean.txt", default_config)
        assert result.passed

    def test_blacklist_load_and_check(self, tmp_path):
        bl_path = tmp_path / "bl.json"
        bl_path.write_text(json.dumps({"hashes": ["abc123", "DEF456"]}))
        bl = HashBlacklist(blacklist_path=str(bl_path))
        assert bl.load()
        assert bl.count == 2
        assert bl.is_blacklisted("abc123")
        assert bl.is_blacklisted("ABC123")  # Case-insensitive
        assert bl.is_blacklisted("def456")
        assert not bl.is_blacklisted("999999")

    def test_blacklist_missing_file(self):
        bl = HashBlacklist(blacklist_path="/nonexistent/path.json")
        assert not bl.load()
        assert bl.count == 0


class TestCombinedMalwareScan:
    @pytest.mark.asyncio
    async def test_all_checks_pass(self, tmp_path, default_config):
        """Clean file, no blacklist match, no ClamAV detection."""
        bl_path = tmp_path / "bl.json"
        bl_path.write_text(json.dumps({"hashes": []}))
        bl = HashBlacklist(blacklist_path=str(bl_path))
        bl.load()

        stage = MalwareScanStage(
            clamav_client=FakeClamAVClient(available=True),
            hash_blacklist=bl,
        )
        result = await stage.scan(FIXTURES / "clean.txt", "clean.txt", default_config)
        assert result.passed

    @pytest.mark.asyncio
    async def test_eicar_with_all_scanners(self, tmp_path, default_config):
        """EICAR should be caught by ClamAV even with empty blacklist."""
        bl_path = tmp_path / "bl.json"
        bl_path.write_text(json.dumps({"hashes": []}))
        bl = HashBlacklist(blacklist_path=str(bl_path))
        bl.load()

        stage = MalwareScanStage(
            clamav_client=FakeClamAVClient(available=True),
            hash_blacklist=bl,
        )
        result = await stage.scan(FIXTURES / "eicar.txt", "eicar.txt", default_config)
        assert not result.passed
